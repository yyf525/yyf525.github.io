## 一：定义

我们先来引入一个定理：

$$
对于一张图，若跑完最短路后，设 u 向 v 连出了权值为 w 的一条有向边，则 dis_v≤dis_u+w(1)
$$

这个应该是很显然的吧，不然就可以靠 $u$ 更新 $v$ 的最短路了。

差分约束就是指给你 $m$ 个不等式，其中每个不等式包含 $X_i-X_j\le C$（ $C$ 是一个常数，$1\le i,j\le n$ ），让你判断是否有解。

这边还有个定理：
$$
若一组差分约束有解，则这组差分约束有无数组解。(2)
$$
证：不妨设这组解为 $(A_1,A_2,\cdots A_n)$，那么 $(A_1+k,A_2+k,\cdots,A_n+k)$ 也一定是一组解（$k$ 是一个常数），因为两个数同时加 $k$，它们的差还是不变。

接下来我们看一组差分约束：

$X_{1}-X_{2}≤2$

$X_{1}-X_{5}≤1$

$X_{2}-X_{5}≤3$

$X_{3}-X_{1}≤7$

$X_{4}-X_{1}≤6$

$X_{4}-X_{3}≤1$

$X_{5}-X_{3}≤-1$

$X_{5}-X_{4}<=-1$

我们将其稍微转换一下，变成：

$X_{1}\le X{2}+2$

$X_{1}\le X{5}+1$

$X_{2}\le X{5}+3$

$X_{3}\le X{1}+7$

$X_{4}\le X{1}+6$

$X_{4}\le X{3}+1$

$X_{5}\le X{3}-1$

$X_{5}\le X{4}-1$

是不是很想最短路转移式的 $dis_v\le dis_u+w$？，那么我们可以对于每个 $X_i\le X_j+w$，变成将 $j$ 连出一条目标为 $i$，边权为 $w$ 的有向边，即建出如下一张图：

![](https://cdn.luogu.com.cn/upload/image_hosting/39a3wkbz.png)

然后跑最短路即可。

## 二：差分约束的应用

### 一：判定条件

我们假设我们根据条件建出了一张图：则有以下三个结论：
$$
若此图有负环，则不等式无解。(3)
$$
$$
若一个点最后跑出来的最短路未被更新过，则这个点可以取任意值。(4)
$$
$$
若未出现以上两种情况，则次差分约束有解。(5)
$$
至于实现，我们直接跑 `spfa`，判断即可。

### 二：极值的求法

#### 最大值

对于求每个点的最大值，即求出每个点 $X_i$ 的上界。

即求出多个不等式链的**最小值**： $X_i\le X_j+c_1\le X_k+c_1+c_2\le\cdots\le X_0+c_1+c_2+\cdots c_p$。

及最后形成：$\begin{cases}X_i\le P_1\\X_i\le P_2\\X_i\le P_3\\~~~~~~~\vdots\\ X_i\le P_t\end{cases}$，即 $X_i$ 的上界是 $min(P_1,P_2,P_3,\cdots,P_t)$，因为是取 $\min$，所以用**最短路**。

#### 最小值

与最大值同理，最后 $X_i$ 的下界是 $max(P_1,P_2,P_3,\cdots,P_t)$，因为是取 $\max$，所以用**最长路**。

这里整理一下：
$$
求最小值，用最长路。(6)
$$
$$
求最大值，用最短路。(7)
$$

## 三：结论的整理

本次学习中共有 $7$ 条结论：
$$
对于一张图，若跑完最短路后，设 u 向 v 连出了权值为 w 的一条有向边，则 dis_v\le dis_u+w(1)
$$

$$
若一组差分约束有解，则这组差分约束有无数组解。(2)
$$

$$
若此图有负环，则不等式无解。(3)
$$

$$
若一个点最后跑出来的最短路未被更新过，则这个点可以取任意值。(4)
$$

$$
若未出现以上两种情况，则次差分约束有解。(5)
$$

$$
求最小值，用最长路。(6)
$$

$$
求最大值，用最短路。(7)
$$
